import{a as f}from"./poem-service-BC27KGA3.js";import{c as l,o as d,a as o,b as I,t as c,F as m,r as u,w as g,v as y,d as w,e as b,n as v,f as C,g as M,E as k}from"./index-KftFhpGg.js";import{_}from"./_plugin-vue_export-helper-DlAUqK2U.js";const x={name:"AIChatBot",props:{poem:{type:Object,default:null}},data(){return{isOpen:!0,messages:[],inputMessage:"",isLoading:!1}},mounted(){this.poem?this.addAIMessage(`您好！我是诗词AI助手，可以帮您分析《${this.poem.title}》这首诗词。您可以问我关于诗词的意境、创作背景、艺术特色等问题。`):this.addAIMessage("您好！我是诗词AI助手，可以帮您赏析诗词、解答疑问。")},methods:{toggleChat(){this.isOpen=!this.isOpen},async sendMessage(){if(!this.inputMessage.trim()||this.isLoading)return;const i=this.inputMessage.trim();this.addUserMessage(i),this.inputMessage="",this.isLoading=!0;try{await this.simulateAIResponse(i)}catch(e){console.error("AI回复出错:",e),this.addAIMessage("抱歉，我暂时无法回答这个问题。请稍后再试。")}finally{this.isLoading=!1}},async simulateAIResponse(i){var e;try{const r=await fetch("http://localhost:5678/webhook/analyze-poem",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:i,poem:this.poem?{title:this.poem.title,author:(e=this.poem.authors)==null?void 0:e.name,content:this.poem.content,dynasty:this.poem.dynasty,genre:this.poem.genre}:null,timestamp:new Date().toISOString()})});if(!r.ok){const t=await r.text();throw new Error(`HTTP ${r.status}: ${t}`)}const h=await r.text();let s="";try{const t=JSON.parse(h);s=t.ai_response||t.reply||t.answer||t.text||t.output||JSON.stringify(t)}catch{s=h}s=s.replace(/^\s+|\s+$/g,""),s.includes("{{ $json")&&(s="⚠️ 请检查 n8n 中 “Respond to Webhook” 节点的输出配置。"),this.addAIMessage(s||"AI暂无回复，请稍后再试。")}catch(r){console.error("调用 n8n 工作流出错:",r),this.addAIMessage("⚠️ 无法连接到 n8n，请确保 http://localhost:5678 正在运行。")}},addUserMessage(i){this.messages.push({type:"user",text:i,timestamp:new Date}),this.scrollToBottom()},addAIMessage(i){this.messages.push({type:"ai",text:i,timestamp:new Date}),this.scrollToBottom()},scrollToBottom(){this.$nextTick(()=>{const i=this.$refs.messagesContainer;i&&(i.scrollTop=i.scrollHeight)})},formatTime(i){return new Date(i).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}}},P={class:"ai-chat-bot"},A={class:"chat-header"},T={key:0,class:"chat-container"},N={class:"messages-container",ref:"messagesContainer"},O={class:"avatar"},B={key:0},J={key:1},L={class:"content"},j={class:"text"},D={class:"time"},S={class:"input-container"},V=["disabled"];function U(i,e,r,h,s,t){return d(),l("div",P,[o("div",A,[e[4]||(e[4]=o("h3",null,"AI诗词助手",-1)),o("button",{class:"toggle-btn",onClick:e[0]||(e[0]=(...n)=>t.toggleChat&&t.toggleChat(...n))},c(s.isOpen?"收起":"展开"),1)]),s.isOpen?(d(),l("div",T,[o("div",N,[(d(!0),l(m,null,u(s.messages,(n,a)=>(d(),l("div",{key:a,class:v(["message",n.type])},[o("div",O,[n.type==="user"?(d(),l("span",B,"👤")):(d(),l("span",J,"🤖"))]),o("div",L,[o("div",j,c(n.text),1),o("div",D,c(t.formatTime(n.timestamp)),1)])],2))),128))],512),o("div",S,[g(o("textarea",{"onUpdate:modelValue":e[1]||(e[1]=n=>s.inputMessage=n),placeholder:"请输入您的问题...",onKeydown:e[2]||(e[2]=w(b((...n)=>t.sendMessage&&t.sendMessage(...n),["prevent"]),["enter"])),rows:"2"},null,544),[[y,s.inputMessage]]),o("button",{onClick:e[3]||(e[3]=(...n)=>t.sendMessage&&t.sendMessage(...n)),disabled:!s.inputMessage.trim()||s.isLoading,class:"send-btn"},c(s.isLoading?"发送中...":"发送"),9,V)])])):I("",!0)])}const Q=_(x,[["render",U],["__scopeId","data-v-d937d7ad"]]),z="https://fddcpkytlhkiuynekjrh.supabase.co",X="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZGNwa3l0bGhraXV5bmVranJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjgzNTUsImV4cCI6MjA3NjA0NDM1NX0.UcDnwdYTBbQikXP2-xxqf2IVmnCHHQLORH2B44cU1XI",R=f(z,X),E={components:{AIChatBot:Q},data(){return{poems:[],page:1,limit:9,totalCount:0,searchQuery:""}},async created(){await this.fetchPoems()},methods:{async fetchPoems(){try{const i=(this.page-1)*this.limit,e=i+this.limit-1,{data:r,error:h,count:s}=await R.from("poems").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range(i,e);if(h)throw h;this.poems=r||[],this.totalCount=s||0}catch(i){console.error("获取诗词失败:",i),k.error("获取诗词数据失败，请稍后重试"),this.poems=[]}},async searchPoems(){this.searchQuery.trim()?this.poems=await searchPoems(this.searchQuery):await this.fetchPoems()},viewPoemDetail(i){this.$router.push(`/poems/${i}`)},async nextPage(){this.page++,await this.fetchPoems()},async prevPage(){this.page>1&&(this.page--,await this.fetchPoems())}}},H={class:"poem-list"},Z={class:"search-box"},F={class:"poem-grid"},G=["onClick"],K={class:"author"},Y={class:"content"},q={class:"meta"},W={class:"pagination"},$=["disabled"],ee=["disabled"];function se(i,e,r,h,s,t){const n=C("AIChatBot");return d(),l("div",H,[e[4]||(e[4]=o("h1",null,"诗词赏析",-1)),M(n),o("div",Z,[g(o("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>s.searchQuery=a),placeholder:"搜索诗词或作者...",onInput:e[1]||(e[1]=(...a)=>t.searchPoems&&t.searchPoems(...a))},null,544),[[y,s.searchQuery]])]),o("div",F,[(d(!0),l(m,null,u(s.poems,a=>{var p;return d(),l("div",{key:a.id,class:"poem-card",onClick:te=>t.viewPoemDetail(a.id)},[o("h3",null,c(a.title),1),o("p",K,c((p=a.authors)==null?void 0:p.name),1),o("p",Y,c(a.content.substring(0,20))+"...",1),o("div",q,[o("span",null,c(a.dynasty)+"·"+c(a.genre),1)])],8,G)}),128))]),o("div",W,[o("button",{onClick:e[2]||(e[2]=(...a)=>t.prevPage&&t.prevPage(...a)),disabled:s.page===1},"上一页",8,$),o("span",null,"第 "+c(s.page)+" 页",1),o("button",{onClick:e[3]||(e[3]=(...a)=>t.nextPage&&t.nextPage(...a)),disabled:s.page>=Math.ceil(s.totalCount/s.limit)},"下一页",8,ee)])])}const ne=_(E,[["render",se],["__scopeId","data-v-7d5c4b2d"]]);export{ne as default};
